---
title: "Statistical Rethinking 2: Chapter 12"
author: Vincent Arel-Bundock
output: html_document
---

# Status

Estimated and checked against the book:

* m12.6

Different results:

* m12.1: Can't replicate with book code either. Did seeds change?

TODO:

* m12.2
* m12.3
* m12.3_alt
* m12.4
* m12.4q
* m12.5
* m12.6

# Libraries

```{r, include=FALSE}
# set default graphics theme if Vincent's personal package is installed
if (requireNamespace('vincent', quietly = TRUE)) {
        vincent::theming()
}
```

```{r, results=FALSE, message=FALSE}
library(tidyverse)
library(tidybayes)
library(rstan)
library(patchwork)
options(mc.cores = 4)
```

# Section 12.1: Over-dispersed counts

```{r, warning=FALSE, message=FALSE, results=FALSE}
stan_program <- '
data {
    int n;
    int gender[n];
    int admit[n];
    int applications[n];
}
parameters {
    vector[2] a;
    real<lower=0> phi;
}
transformed parameters {
    vector[n] pbar;
    real theta;
    theta = phi + 2;
    for (i in 1:n) {
        pbar[i] = a[gender[i]];
        pbar[i] = inv_logit(pbar[i]);
    }
}
model {
    phi ~ exponential(1);
    a ~ normal(0, 1.5);
    admit ~ beta_binomial(applications, pbar * theta, (1 - pbar) * theta);
}
generated quantities {
    real da;
    da = a[1] - a[2];
}
'

stan_data <- read.csv('data/UCBadmit.csv', sep = ';') %>%
             rename(gender = applicant.gender) %>%
             compose_data

m12.1 <- stan(model_code = stan_program, data = stan_data, iter = 5000)
```

```{r}
summary(m12.1, c('a', 'phi'))$summary
```

```{r}
datplot <- m12.1 %>%
           spread_draws(a[i], theta) %>%
		   filter(i == 2) %>%
		   sample_n(1000) 

plot(NULL, xlim = c(0, 1), ylim = c(0, 4),
	 xlab = 'Probability admit', ylab = 'Density')
for (i in 1:nrow(datplot)) {
    a <- 1 / (1 + exp(-datplot$a[i]))
    b <- datplot$theta[1]
    curve(rethinking::dbeta2(x, a, b), add = TRUE,
          col = adjustcolor('grey', alpha = .1))
}
a <- 1 / (1 + exp(-mean(datplot$a)))
b <- mean(datplot$theta)
curve(rethinking::dbeta2(x, a, b), add = TRUE)
```

# Section 12.4: Ordered categorical predictors

```{r, warning=FALSE, message=FALSE, results=FALSE}
stan_program <- '
data{
    int n;
    int response[n];
    int contact[n];
    int intention[n];
    int action[n];
    int edu_new[n];
    vector[7] alpha;
}
parameters{
    ordered[6] kappa;
    real bE;
    real bC;
    real bI;
    real bA;
    simplex[7] delta;
}
model{
    vector[n] phi;
    vector[8] delta_j;
    delta ~ dirichlet( alpha );
    delta_j = append_row(0, delta);
    bA ~ normal( 0 , 1 );
    bI ~ normal( 0 , 1 );
    bC ~ normal( 0 , 1 );
    bE ~ normal( 0 , 1 );
    kappa ~ normal( 0 , 1.5 );
    for ( i in 1:n ) {
        phi[i] = bE * sum(delta_j[1:edu_new[i]]) + 
                 bA * action[i] + 
                 bI * intention[i] + 
                 bC * contact[i];
    }
    for ( i in 1:n ) response[i] ~ ordered_logistic( phi[i] , kappa );
}
'

stan_data <- read.csv('data/Trolley.csv', sep = ';') %>%
             # ordered education levels
             mutate(edu_new = factor(edu, levels = c("Elementary School",
                                                     "Middle School",
                                                     "Some High School",
                                                     "High School Graduate",
                                                     "Some College",
                                                     "Bachelor's Degree",
                                                     "Master's Degree",
                                                     "Graduate Degree"))) %>%
            compose_data(alpha = rep(2, 7))

m12.6 <- stan(model_code = stan_program, data = stan_data)
```

```{r}
summary(m12.6, c('bE', 'bC', 'bI', 'bA', 'delta'))$summary
```
